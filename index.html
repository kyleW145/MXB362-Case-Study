<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAPD Crime Map</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* Base Layout */
        body {
            display: flex;
            height: 100vh;
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f8f9fa;
        }
    
        #controls {
            width: 550px;
            background: white;
            padding: 1.5rem;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            border-right: 1px solid #e5e7eb;
        }
    
        #map {
            flex: 1;
        }
    
        /* Control Sections */
        .control-section {
            background: white;
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
        }
    
        .control-section h4 {
            color: #1a202c;
            font-size: 1.1rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e2e8f0;
            font-weight: 600;
        }
    
        /* Button Styles */
        #regionsButton {
            width: 100%;
            margin-bottom: 1.25rem;
            padding: 0.75rem;
            font-weight: 500;
            border-radius: 6px;
            background-color: #4b5563;
            border-color: #374151;
            color: white;
        }
    
        #regionsButton:hover {
            background-color: #374151;
        }
    
        .btn-outline-primary {
            color: #4b5563;
            border-color: #4b5563;
        }
    
        .btn-outline-primary:hover, 
        .btn-outline-primary.active {
            background-color: #4b5563;
            border-color: #374151;
            color: white;
        }
    
        .btn-primary {
            background-color: #4b5563;
            border-color: #374151;
            color: white;
        }
    
        .btn-primary:hover {
            background-color: #374151;
            border-color: #1f2937;
        }
    
        .btn-secondary {
            background-color: #6b7280;
            border-color: #4b5563;
            color: white;
        }
    
        .btn-secondary:hover {
            background-color: #4b5563;
            border-color: #374151;
        }
    
        .btn-danger {
            background-color: #9ca3af;
            border-color: #6b7280;
            color: white;
        }
    
        .btn-danger:hover {
            background-color: #6b7280;
            border-color: #4b5563;
        }
    
        .btn-info {
            background-color: #4b5563;
            border-color: #374151;
            color: white;
        }
    
        .btn-info:hover {
            background-color: #374151;
            border-color: #1f2937;
        }
    
        .btn:focus {
            box-shadow: 0 0 0 0.2rem rgba(75, 85, 99, 0.25);
        }
    
        /* Control Groups */
        .view-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
    
        .btn-group .btn {
            border-radius: 4px;
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
        }
    
        .time-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
    
        .time-controls .btn {
            flex: 1;
            padding: 0.5rem;
            font-size: 0.9rem;
            border-radius: 4px;
        }
    
        /* Scrubber Styles */
        .scrubber-container {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 6px;
            margin-top: 0.75rem;
            border: 1px solid #e2e8f0;
        }
    
        .form-control-range {
            width: 100%;
            margin-top: 0.5rem;
        }
    
        /* Filter Sections */
        .filter-section {
            margin-bottom: 1rem;
        }
    
        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 0.75rem;
            background: #f8fafc;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
        }
    
        .filter-header:hover {
            background: #f1f5f9;
        }
    
        .filter-content {
            padding: 0.75rem;
            background: white;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
        }
    
        /* Toggle Buttons */
        .toggle-btn {
            width: 28px;
            height: 28px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #d1d5db;
            background: white;
            color: #4b5563;
            font-weight: bold;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
    
        .toggle-btn:hover {
            background: #f3f4f6;
            color: #1f2937;
            border-color: #9ca3af;
        }
    
        /* Checkbox Styles */
        .checkbox-label {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: #4a5568;
            padding: 0.5rem;
            border-radius: 4px;
            transition: background-color 0.2s;
            cursor: pointer;
        }
    
        .checkbox-label:hover {
            background-color: #f1f5f9;
        }
    
        .checkbox-label input[type="checkbox"] {
            margin-right: 0.75rem;
        }
    
        /* Date Picker */
        .date-picker {
            margin-bottom: 1.25rem;
        }
    
        .date-picker label {
            font-weight: 500;
            color: #4a5568;
            margin-bottom: 0.5rem;
            display: block;
        }
    
        .date-picker input {
            border-radius: 4px;
            border: 1px solid #e2e8f0;
            padding: 0.5rem;
            width: 100%;
        }
    
        /* Week Display */
        #weekDisplay {
            font-size: 0.9rem;
            color: #718096;
            padding: 0.75rem;
            background: #f8fafc;
            border-radius: 4px;
            margin-top: 0.75rem;
            border: 1px solid #e2e8f0;
        }
    
        /* Time Display */
        #scrubberValue, #weekScrubberValue {
            text-align: center;
            font-size: 0.9rem;
            color: #4a5568;
            margin-top: 0.75rem;
            padding: 0.5rem;
            background: white;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
        }
    
        /* Labels */
        .control-label {
            font-weight: 500;
            color: #4a5568;
            margin-bottom: 0.5rem;
            display: block;
        }
    
        /* Bar Chart Styles */
        .bar-chart {
            opacity: 0;
            transition: opacity 0.3s ease;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
            pointer-events: all;
        }
    
        .bar-chart.visible {
            opacity: 1;
        }
    
        .bar-chart-title {
            font-size: 16px;
            font-weight: bold;
            fill: #374151;
        }
    
        .bar {
            fill: #4b5563;
            transition: fill 0.3s ease;
        }
    
        .bar:hover {
            fill: #374151;
        }
    
        .bar-text {
            font-size: 12px;
            fill: #374151;
        }
    
        /* Legend Styles */
        .legend {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
    
        .legend h4 {
            margin: 0;
            font-size: 16px;
            color: #1a202c;
        }
    
        .legend div {
            display: flex;
            align-items: center;
        }
    
        .legend div span {
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }
    
        /* Tooltip */
        .custom-tooltip {
            background-color: white;
            color: #1a202c;
            padding: 10px;
            border-radius: 5px;
            font-size: 16px;
            max-width: 400px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn-group .btn-outline-primary {
        color: #4b5563;
        border-color: #4b5563;
        background-color: transparent;
    }

    .btn-group .btn-outline-primary:hover,
    .btn-group .btn-outline-primary:active,
    .btn-group .btn-outline-primary.active,
    .btn-group .btn-outline-primary:focus {
        background-color: #4b5563 !important;
        border-color: #374151 !important;
        color: white !important;
        box-shadow: none !important;
    }

    .btn-group .btn-outline-primary:not(:disabled):not(.disabled):active,
    .btn-group .btn-outline-primary:not(:disabled):not(.disabled).active {
        background-color: #4b5563 !important;
        border-color: #374151 !important;
        color: white !important;
    }

    .btn-group .btn-outline-primary:focus {
        box-shadow: 0 0 0 0.2rem rgba(75, 85, 99, 0.25) !important;
    }

    /* Ensure buttons in button group maintain border radius */
    .btn-group > .btn {
        border-radius: 4px !important;
        margin: 0 2px;
    }
    </style>
    
</head>
<body>
    <div id="controls">

        <div style="background-color: #1a202c; padding: 1.5rem; margin: -1.5rem -1.5rem 1.5rem -1.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h2 style="color: white; margin: 0; font-size: 2rem; font-weight: 700; text-align: center; font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; letter-spacing: 0.025em;">LAPD Crime Map</h2>
        </div>

        <!-- Info message in its own section -->
        <div class="control-section" style="margin-top: 0;">
            <p style="color: #4a5568; font-size: 1rem; margin: 0; text-align: center; line-height: 1.5;">
                Click on any police region to view detailed reporting district information.
            </p>
        </div>
        <div class="control-section">
            <button class="btn btn-info" id="regionsButton">Return to Regional View</button>
            
            <div class="date-picker">
                <label class="control-label" for="dateInput">Select Date</label>
                <input type="date" class="form-control" id="dateInput" value="2024-01-01" min="2024-01-01" max="2024-10-03">
            </div>

            <div class="view-controls">
                <div class="btn-group w-100" role="group">
                    <button class="btn btn-outline-primary active" id="dailyButton">Daily</button>
                    <button class="btn btn-outline-primary" id="weeklyButton">Weekly</button>
                </div>
            </div>

            <div id="weekDisplay" style="display: none;">
                <small class="text-muted">Week: <span id="weekRange"></span></small>
            </div>
        </div>

        <div class="control-section">
            <h4>Time Controls</h4>
            <div class="time-controls">
                <button class="btn btn-primary" id="playButton">Play</button>
                <button class="btn btn-secondary" id="pauseButton">Pause</button>
                <button class="btn btn-danger" id="stopButton">Reset</button>
            </div>

            <div id="dailyScrubber" class="scrubber-container">
                <label class="control-label" for="scrubber">Time of Day</label>
                <input type="range" class="form-control-range" id="scrubber" min="1" max="6" value="1" step="1">
                <div id="scrubberValue">12:00 AM - 4:00 AM</div>
            </div>

            <div id="weeklyScrubber" class="scrubber-container" style="display: none;">
                <label class="control-label" for="weekScrubber">Day of Week</label>
                <input type="range" class="form-control-range" id="weekScrubber" min="1" max="7" value="1" step="1">
                <div id="weekScrubberValue">Monday</div>
            </div>
        </div>

        <div class="control-section">
            <h4>Filters</h4>
            
            <div class="filter-section">
                <div class="filter-header">
                    <span>Crime Categories</span>
                    <button class="toggle-btn" id="toggleCrimeCategories">+</button>
                </div>
                <div id="crimeCategoryFilters" class="filter-content" style="display: none;">
                    <label class="checkbox-label">
                        <input type="checkbox" value="Violent Crime" checked> Violent Crime
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="Property Crime" checked> Property Crime
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="Vehicle-Related Crime" checked> Vehicle-Related Crime
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="Theft" checked> Theft
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="Financial Fraud" checked> Financial Fraud
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="Other/Miscellaneous" checked> Other/Miscellaneous
                    </label>
                </div>
            </div>

            <div class="filter-section">
                <div class="filter-header">
                    <span>Weapon Categories</span>
                    <button class="toggle-btn" id="toggleWeaponCategories">+</button>
                </div>
                <div id="weaponCategoryFilters" class="filter-content" style="display: none;">
                    <label class="checkbox-label">
                        <input type="checkbox" value="No Weapon Used" checked> No Weapon Used
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="Weapon Used" checked> Weapon Used
                    </label>
                </div>
            </div>

            <div class="filter-section">
                <div class="filter-header">
                    <span>Victim Sex</span>
                    <button class="toggle-btn" id="toggleVictimSex">+</button>
                </div>
                <div id="victimSexFilters" class="filter-content" style="display: none;">
                    <label class="checkbox-label">
                        <input type="checkbox" value="Female" checked> Female
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="Male" checked> Male
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="Not Reported" checked> Not Reported
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="Unknown" checked> Unknown
                    </label>
                </div>
            </div>

            <div class="filter-section">
                <div class="filter-header">
                    <span>Victim Descent</span>
                    <button class="toggle-btn" id="toggleVictimDescent">+</button>
                </div>
                <div id="victimDescentFilters" class="filter-content" style="display: none;">
                    <label class="checkbox-label">
                        <input type="checkbox" value="White" checked> White
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="Asian" checked> Asian
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="Other" checked> Other
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="Hispanic/Latino" checked> Hispanic/Latino
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="Black" checked> Black
                    </label>
                </div>
            </div>

            <div class="filter-section">
                <div class="filter-header">
                    <span>Victim Age Category</span>
                    <button class="toggle-btn" id="toggleVictimAge">+</button>
                </div>
                <div id="victimAgeFilters" class="filter-content" style="display: none;">
                    <label class="checkbox-label">
                        <input type="checkbox" value="Not Reported" checked> Not Reported
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="Childhood: 0-12 Years" checked> Childhood: 0-12 Years
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="Teens: 13-19 Years" checked> Teens: 13-19 Years
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="Young Adults: 20-34 Years" checked> Young Adults: 20-34 Years
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="Middle-Aged Adults: 35-54 Years" checked> Middle-Aged Adults: 35-54 Years
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="Older Adults/Seniors: 55+ Years" checked> Older Adults/Seniors: 55+ Years
                    </label>
                </div>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <script>
        // Initialize state tracking variables
        let currentViewState = 'region';
        let currentAprec = null;
        let currentChoroplethLayer = null;
        let markersLayer;
        let current = 1;
        let interval;
        let isPlaying = false;
        let crimeData = null;

        let isWeeklyView = false;

        let currentWeekDay = 1;
        function updateScrubberVisibility() {
            document.getElementById('dailyScrubber').style.display = isWeeklyView ? 'none' : 'block';
            document.getElementById('weeklyScrubber').style.display = isWeeklyView ? 'block' : 'none';
            // Hide time controls in weekly view
            document.getElementById('scrubberValue').style.display = isWeeklyView ? 'none' : 'block';
        }

        function getDayName(dayIndex) {
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            return days[dayIndex - 1];
        }

        function getDateFromWeekDay(baseDate, targetDay) {
            const weekRange = getWeekRange(baseDate);
            const result = new Date(weekRange.start);
            result.setDate(result.getDate() + (targetDay - 1));
            return formatDate(result);
        }

        // Function to format date as YYYY-MM-DD
        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        // Function to get week range from a date
        function getWeekRange(date) {
            const selectedDate = new Date(date);
            const weekStart = new Date(selectedDate);
            // Set to Monday of the week
            weekStart.setDate(selectedDate.getDate() - selectedDate.getDay() + (selectedDate.getDay() === 0 ? -6 : 1));

            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);

            return {
                start: weekStart,
                end: weekEnd,
                startStr: formatDate(weekStart),
                endStr: formatDate(weekEnd)
            };
        }

        // Function to update week display
        function updateWeekDisplay(date) {
            const weekRange = getWeekRange(date);
            const weekDisplay = document.getElementById('weekDisplay');
            const weekRangeText = document.getElementById('weekRange');

            if (isWeeklyView) {
                weekDisplay.style.display = 'block';
                weekRangeText.textContent = `${weekRange.startStr} to ${weekRange.endStr}`;
            } else {
                weekDisplay.style.display = 'none';
            }
        }

        // defining colour schemes
        let regionalColour = d3.schemeBlues[9];
        let districtColour = d3.schemePurples[9];

        const regionalDayColourScale = d3.scaleQuantize()
            .domain([0, 15])
            .range(regionalColour);

        const regionalWeekColourScale = d3.scaleQuantize()
            // update domain (and related scale text somewhere)
            .domain([0, 45])
            .range(regionalColour);

        const districtDayColourScale = d3.scaleQuantize()
            .domain([0, 5])
            .range(districtColour);

        const districtWeekColourScale = d3.scaleQuantize()
            // update domain (and related scale text somewhere)
            .domain([0, 10])
            .range(districtColour);


        // Initialize the map
        const map = L.map('map').setView([34.022, -118.3337], 11);
        map.setMinZoom(11);

        // Add base layers
        const imageryLayer = L.tileLayer('https://server.arcgisonline.com/arcgis/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 17,
            attribution: 'Tiles © Esri'
        }).addTo(map);


        const labelsLayer = L.tileLayer('https://c.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}.png', {
            maxZoom: 17,
            minZoom: 11,
            attribution: '© OpenStreetMap contributors, © CartoDB'
        }).addTo(map);

        let activeChart = null;

        function displayBarChart(data, event, regionName) {
    // Remove any existing charts
    if (activeChart) {
        activeChart.remove();
    }
    d3.selectAll('.bar-chart').remove();

    if (!data || Object.keys(data).length === 0) return;

    const chartWidth = 800;
    const chartHeight = 400;
    const margin = { top: 60, right: 40, bottom: 60, left: 200 };
    const width = chartWidth - margin.left - margin.right;
    const height = chartHeight - margin.top - margin.bottom;

    // Calculate position based on mouse event
    let xPosition = event.containerPoint.x + 50;
    let yPosition = event.containerPoint.y;

    // Convert map coordinates to page coordinates
    const mapRect = map.getContainer().getBoundingClientRect();
    xPosition += mapRect.left;
    yPosition += mapRect.top;

    // Ensure chart stays within viewport
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;

    if (xPosition + chartWidth > viewportWidth) {
        xPosition = Math.max(0, viewportWidth - chartWidth - 20);
    }
    if (yPosition + chartHeight > viewportHeight) {
        yPosition = Math.max(0, viewportHeight - chartHeight - 20);
    }

    const svg = d3.select('body').append('svg')
        .attr('class', 'bar-chart')
        .attr('width', chartWidth)
        .attr('height', chartHeight)
        .style('position', 'fixed')
        .style('left', xPosition + 'px')
        .style('top', yPosition + 'px')
        .style('z-index', 1000);

    // Store the current chart
    activeChart = svg.node();

    // Add white background
    svg.append('rect')
        .attr('width', chartWidth)
        .attr('height', chartHeight)
        .attr('fill', 'white')
        .attr('opacity', 0.95);

    const g = svg.append('g')
        .attr('transform', `translate(${margin.left},${margin.top})`);

    // Sort data by value in descending order and take top 8
    const sortedData = Object.entries(data)
        .sort(([, a], [, b]) => b - a)
        .slice(0, 8);

    // Calculate total count
    const totalCount = sortedData.reduce((acc, [, count]) => acc + count, 0);

    // Add centered title with total count
    svg.append('text')
        .attr('class', 'bar-chart-title')
        .attr('x', chartWidth / 2)
        .attr('y', margin.top / 2)
        .attr('text-anchor', 'middle')
        .style('font-size', '20px')
        .style('font-weight', 'bold')
        .text(`${regionName} - Total Crimes: ${totalCount}`);

    if (sortedData.length === 0) return;

    // Set up scales
    const y = d3.scaleBand()
        .range([0, height])
        .padding(0.4)
        .domain(sortedData.map(d => d[0]));

    const maxValue = Math.ceil(d3.max(sortedData, d => d[1]));
    const x = d3.scaleLinear()
        .range([0, width])
        .domain([0, maxValue]);

    // Add X axis
    g.append("g")
        .attr("transform", `translate(0,${height})`)
        .call(d3.axisBottom(x)
            .tickValues(Array.from({ length: maxValue + 1 }, (_, i) => i))
            .tickFormat(d3.format("d"))
            .tickSize(-height))
        .selectAll(".tick line")
        .attr("stroke", "#ddd");

    // Add Y axis (simplified, no text wrapping)
    g.append("g")
        .call(d3.axisLeft(y)
            .tickSize(0))
        .selectAll(".tick text")
        .style("font-size", "14px");

    // Add bars with animation
    g.selectAll('.bar')
        .data(sortedData)
        .enter().append('rect')
        .attr('class', 'bar')
        .attr('y', d => y(d[0]))
        .attr('x', 0)
        .attr('height', y.bandwidth())
        .attr('width', 0)
        .transition()
        .duration(500)
        .attr('width', d => x(d[1]));

    // Make chart visible
    svg.classed('visible', true);
}

        function addGeoJSONLayer(url, color, weight) {
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    L.geoJSON(data, {
                        style: function (feature) {
                            return {
                                color: color,
                                weight: weight,
                                fillOpacity: 0
                            };
                        }
                    }).addTo(map);
                })
                .catch(error => {
                    console.error('Error loading GeoJSON:', error);
                });
        }

        // Add the LAPD police regions
        addGeoJSONLayer('data/geojson/police_regions.geojson', '#000000', 10);

        function getSelectedWeaponCategories() {
            const checkboxes = document.querySelectorAll('#weaponCategoryFilters input[type="checkbox"]');
            return Array.from(checkboxes)
                .filter(checkbox => checkbox.checked)
                .map(checkbox => checkbox.value);
        }

        function getSelectedCrimeCategories() {
            const checkboxes = document.querySelectorAll('#crimeCategoryFilters input[type="checkbox"]');
            return Array.from(checkboxes)
                .filter(checkbox => checkbox.checked)
                .map(checkbox => checkbox.value);
        }

        function getSelectedVictimSex() {
            const checkboxes = document.querySelectorAll('#victimSexFilters input[type="checkbox"]');
            return Array.from(checkboxes)
                .filter(checkbox => checkbox.checked)
                .map(checkbox => checkbox.value);
        }

        function getSelectedVictimDescent() {
            const checkboxes = document.querySelectorAll('#victimDescentFilters input[type="checkbox"]');
            return Array.from(checkboxes)
                .filter(checkbox => checkbox.checked)
                .map(checkbox => checkbox.value);
        }

        function getSelectedVictimAge() {
            const checkboxes = document.querySelectorAll('#victimAgeFilters input[type="checkbox"]');
            return Array.from(checkboxes)
                .filter(checkbox => checkbox.checked)
                .map(checkbox => checkbox.value);
        }

        let legend;

        function createLegend(grades, scheme) {
            if (legend) {
                legend.remove();
            }

            const legendWidth = 150;
            const legendHeight = 600;

            legend = d3.select("body").append("svg")
                .attr("class", "legend")
                .attr("width", legendWidth)
                .attr("height", legendHeight)
                .style("position", "absolute")
                .style("top", "250px")
                .style("right", "20px");

            legend.append("text")
                .attr("x", 10)
                .attr("y", 20)
                .attr("font-size", "16px")
                .attr("font-weight", "bold")
                .text("Crime Count");

            const gradient = legend.append("defs")
                .append("linearGradient")
                .attr("id", "colorGradient")
                .attr("x1", "0%")
                .attr("y1", "0%")
                .attr("x2", "0%")
                .attr("y2", "100%");

            scheme.forEach((color, i) => {
                gradient.append("stop")
                    .attr("offset", `${(i / (scheme.length - 1)) * 100}%`)
                    .attr("stop-color", color);
            });

            legend.append("rect")
                .attr("x", 10)
                .attr("y", 30)
                .attr("width", 30)
                .attr("height", legendHeight - 60)
                .style("fill", "url(#colorGradient)")
                .style("fill-opacity", 0.9);

            const labelHeight = (legendHeight - 60) / (grades.length - 1);

            grades.forEach((grade, i) => {
                legend.append("text")
                    .attr("x", 50)
                    .attr("y", 35 + labelHeight * i)
                    .attr("font-size", "14px")
                    .text(grade);
            });
        }

        function loadCrimeData(date, timeClass) {
            updateWeekDisplay(date);

            let effectiveDate = date;
            if (isWeeklyView) {
                const weekRange = getWeekRange(date);
                const selectedDate = new Date(weekRange.start);
                selectedDate.setDate(selectedDate.getDate() + (currentWeekDay - 1));
                effectiveDate = formatDate(selectedDate);
            }

            if (currentViewState === 'district' && currentAprec) {
                loadCrimeDataRegion(effectiveDate, timeClass, currentAprec);
                return;
            }

            d3.json("data/geojson/police_regions.geojson").then(geoData => {
                const aprecNames = geoData.features.map(feature => feature.properties.APREC);
                const crimePromises = aprecNames.map(aprec => d3.json(`data/crime/Crime_Data_${aprec}.json`).catch(() => []));

                Promise.all(crimePromises).then(crimeDataArray => {
                    const crimeCount = {};
                    const crimeCategories = {};

                    crimeDataArray.forEach((crimeData, index) => {
                        const region = aprecNames[index];
                        const allowedWeaponCategories = getSelectedWeaponCategories();
                        const allowedVictimSex = getSelectedVictimSex();
                        const allowedVictimDescent = getSelectedVictimDescent();
                        const allowedVictimAge = getSelectedVictimAge();
                        const allowedCrimeCategories = getSelectedCrimeCategories();

                        crimeData.forEach(crime => {
                            let includeRecord = false;
                            if (isWeeklyView) {
                                // In weekly view, include all time periods for the selected day
                                includeRecord = crime.Date === effectiveDate;
                            } else {
                                // In daily view, only include the selected time period
                                includeRecord = crime.Date === date && crime.Time_Class === timeClass;
                            }

                            if (includeRecord &&
                                allowedWeaponCategories.includes(crime.Weapon_Category) &&
                                allowedVictimSex.includes(crime.Victim_Sex) &&
                                allowedVictimDescent.includes(crime.Victim_Descent_Category) &&
                                allowedVictimAge.includes(crime.Age_Category) &&
                                allowedCrimeCategories.includes(crime.Crime_Category)
                            ) {
                                crimeCount[region] = (crimeCount[region] || 0) + 1;
                                const category = crime.Crime_Category;
                                crimeCategories[region] = crimeCategories[region] || {};
                                crimeCategories[region][category] = (crimeCategories[region][category] || 0) + 1;
                            }
                        });
                    });

                    if (currentChoroplethLayer) {
                        map.removeLayer(currentChoroplethLayer);
                    }

                    currentChoroplethLayer = L.geoJSON(geoData, {
                        style: feature => {
                            const regionName = feature.properties.APREC;
                            const count = crimeCount[regionName] || 0;
                            return {
                                fillColor: isWeeklyView ? regionalWeekColourScale(count) : regionalDayColourScale(count),
                                weight: 5,
                                opacity: 1,
                                color: 'black',
                                fillOpacity: 0.8
                            };
                        },
                        onEachFeature: (feature, layer) => {
                            const regionName = feature.properties.APREC;
                            const count = crimeCount[regionName] || 0;

                            const timeText = isWeeklyView ?
                                `Full Day` :
                                getTimeRange(timeClass);
                            const dateText = isWeeklyView ?
                                `${getDayName(currentWeekDay)}, ${effectiveDate}` :
                                `Date: ${date}`;


                            layer.on('mouseover', (e) => {
                                displayBarChart(crimeCategories[regionName], e, regionName);
                            });

                            layer.on('mouseout', () => {
                                if (activeChart) {
                                    activeChart.remove();
                                    activeChart = null;
                                }
                            });

                            layer.on('click', () => {
                                currentViewState = 'district';
                                currentAprec = regionName;
                                const bounds = layer.getBounds();
                                map.fitBounds(bounds);
                                loadCrimeDataRegion(effectiveDate, timeClass, regionName);
                                const levels = [0, 1, 2, 3, 4, "5+"];
                                createLegend(levels, districtColour);
                            });
                        }
                    }).addTo(map);

                    const grades = isWeeklyView ? [0, 10, 20, 30, "45+"] : [0, 5, 10, "15+"];
                    createLegend(grades, regionalColour);
                });
            });
        }

        function getDistrictCrimeCategories(reportDistrict) {
    const categories = {};
    if (!crimeData) return categories;

    const allowedWeaponCategories = getSelectedWeaponCategories();
    const allowedVictimSex = getSelectedVictimSex();
    const allowedVictimDescent = getSelectedVictimDescent();
    const allowedVictimAge = getSelectedVictimAge();
    const allowedCrimeCategories = getSelectedCrimeCategories();

    const date = document.getElementById('dateInput').value;
    let effectiveDate = date;

    if (isWeeklyView) {
        const weekRange = getWeekRange(date);
        const selectedDate = new Date(weekRange.start);
        selectedDate.setDate(selectedDate.getDate() + (currentWeekDay - 1));
        effectiveDate = formatDate(selectedDate);
    }

    crimeData.forEach(crime => {
        let includeRecord = false;
        if (isWeeklyView) {
            // In weekly view, include ALL time periods for the selected day
            includeRecord = crime.Date === effectiveDate;
        } else {
            includeRecord = crime.Date === effectiveDate && crime.Time_Class === current;
        }

        if (crime.Report_District === reportDistrict &&
            includeRecord &&
            allowedWeaponCategories.includes(crime.Weapon_Category) &&
            allowedVictimSex.includes(crime.Victim_Sex) &&
            allowedVictimDescent.includes(crime.Victim_Descent_Category) &&
            allowedVictimAge.includes(crime.Age_Category) &&
            allowedCrimeCategories.includes(crime.Crime_Category)) {

            const category = crime.Crime_Category;
            categories[category] = (categories[category] || 0) + 1;
        }
    });
    return categories;
}

// Update loadCrimeDataRegion to show full day counts
function loadCrimeDataRegion(date, timeClass, targetAprec) {
    d3.json("data/geojson/LAPD_Reporting_Districts.geojson").then(geoData => {
        const matchingFeature = geoData.features.find(feature => feature.properties.APREC === targetAprec);

        if (!matchingFeature) {
            console.error("No matching feature found for Aprec:", targetAprec);
            return;
        }

        d3.json(`data/crime/Crime_Data_${targetAprec}.json`).then(loadedCrimeData => {
            crimeData = loadedCrimeData;
            const crimeCount = {};
            const crimeCategories = {};

            const allowedWeaponCategories = getSelectedWeaponCategories();
            const allowedVictimSex = getSelectedVictimSex();
            const allowedVictimDescent = getSelectedVictimDescent();
            const allowedVictimAge = getSelectedVictimAge();
            const allowedCrimeCategories = getSelectedCrimeCategories();

            // Process all crimes for the current date/day
            crimeData.forEach(crime => {
                let includeRecord = false;
                if (isWeeklyView) {
                    // In weekly view, include ALL time periods for the selected day
                    includeRecord = crime.Date === date;
                } else {
                    // In daily view, only include specific time period
                    includeRecord = crime.Date === date && crime.Time_Class === timeClass;
                }

                if (includeRecord &&
                    allowedWeaponCategories.includes(crime.Weapon_Category) &&
                    allowedVictimSex.includes(crime.Victim_Sex) &&
                    allowedVictimDescent.includes(crime.Victim_Descent_Category) &&
                    allowedVictimAge.includes(crime.Age_Category) &&
                    allowedCrimeCategories.includes(crime.Crime_Category)) {

                    const reportDistrict = crime.Report_District;
                    crimeCount[reportDistrict] = (crimeCount[reportDistrict] || 0) + 1;

                    // Store crime categories for each district
                    if (!crimeCategories[reportDistrict]) {
                        crimeCategories[reportDistrict] = {};
                    }
                    const category = crime.Crime_Category;
                    crimeCategories[reportDistrict][category] = (crimeCategories[reportDistrict][category] || 0) + 1;
                }
            });

            const filteredGeoData = {
                type: "FeatureCollection",
                features: geoData.features.filter(feature => feature.properties.APREC === targetAprec)
            };

            if (filteredGeoData.features.length === 0) {
                console.error("No features found for the specified Aprec:", targetAprec);
                return;
            }

            if (currentChoroplethLayer) {
                map.removeLayer(currentChoroplethLayer);
            }

            // Create the choropleth layer with the updated counts
            currentChoroplethLayer = L.geoJSON(filteredGeoData, {
                style: feature => {
                    const reportDistrict = feature.properties.NAME;
                    const count = crimeCount[reportDistrict] || 0;
                    return {
                        fillColor: isWeeklyView ? districtWeekColourScale(count) : districtDayColourScale(count),
                        weight: 2,
                        opacity: 1,
                        color: 'black',
                        fillOpacity: 0.8
                    };
                },
                onEachFeature: (feature, layer) => {
                    const reportDistrict = feature.properties.NAME;
                    const count = crimeCount[reportDistrict] || 0;

                    const timeText = isWeeklyView ? 'Full Day' : getTimeRange(timeClass);
                    const dateText = isWeeklyView ? 
                        `${getDayName(currentWeekDay)}, ${date}` : 
                        `Date: ${date}`;

                    layer.on('mouseover', (e) => {
                        const districtCrimeCategories = crimeCategories[reportDistrict] || {};
                        displayBarChart(districtCrimeCategories, e, `District ${reportDistrict}`);
                    });

                    layer.on('mouseout', () => {
                        if (activeChart) {
                            activeChart.remove();
                            activeChart = null;
                        }
                    });
                }
            }).addTo(map);

            // Update legend with appropriate ranges
            const grades = isWeeklyView ? [0, 10, 20, 30, "10+"] : [0, 1, 2, 3, 4, "5+"];
            createLegend(grades, districtColour);
        });
    });
}

        // Add event listeners for view mode buttons
        document.getElementById('dailyButton').addEventListener('click', function () {
            if (isWeeklyView) {
                isWeeklyView = false;
                this.classList.add('active');
                document.getElementById('weeklyButton').classList.remove('active');
                updateScrubberVisibility();
                loadCrimeData(document.getElementById('dateInput').value, current);
            }
        });

        document.getElementById('weeklyButton').addEventListener('click', function () {
            if (!isWeeklyView) {
                isWeeklyView = true;
                this.classList.add('active');
                document.getElementById('dailyButton').classList.remove('active');
                updateScrubberVisibility();
                currentWeekDay = 1;
                document.getElementById('weekScrubber').value = currentWeekDay;
                document.getElementById('weekScrubberValue').innerText = getDayName(currentWeekDay);
                loadCrimeData(document.getElementById('dateInput').value, current);
            }
        });

        // Update getDistrictCrimeCategories to handle weekly view
        function getDistrictCrimeCategories(reportDistrict) {
            const categories = {};
            if (!crimeData) return categories;

            const allowedWeaponCategories = getSelectedWeaponCategories();
            const allowedVictimSex = getSelectedVictimSex();
            const allowedVictimDescent = getSelectedVictimDescent();
            const allowedVictimAge = getSelectedVictimAge();
            const allowedCrimeCategories = getSelectedCrimeCategories();

            const date = document.getElementById('dateInput').value;

            crimeData.forEach(crime => {
                let includeRecord = false;
                if (isWeeklyView) {
                    const crimeDate = new Date(crime.Date);
                    const weekRange = getWeekRange(date);
                    includeRecord = crimeDate >= weekRange.start &&
                        crimeDate <= weekRange.end &&
                        crime.Time_Class === current;
                } else {
                    includeRecord = crime.Date === date && crime.Time_Class === current;
                }

                if (crime.Report_District === reportDistrict &&
                    includeRecord &&
                    allowedWeaponCategories.includes(crime.Weapon_Category) &&
                    allowedVictimSex.includes(crime.Victim_Sex) &&
                    allowedVictimDescent.includes(crime.Victim_Descent_Category) &&
                    allowedVictimAge.includes(crime.Age_Category) &&
                    allowedCrimeCategories.includes(crime.Crime_Category)) {

                    const category = crime.Crime_Category;
                    categories[category] = (categories[category] || 0) + 1;
                }
            });
            return categories;
        }
        function getTimeRange(sixth) {
            switch (sixth) {
                case 1: return "12:00 AM - 4:00 AM";
                case 2: return "4:00 AM - 8:00 AM";
                case 3: return "8:00 AM - 12:00 PM";
                case 4: return "12:00 PM - 4:00 PM";
                case 5: return "4:00 PM - 8:00 PM";
                case 6: return "8:00 PM - 12:00 AM";
                default: return "";
            }
        }

        // Filter event listeners
        const addFilterListener = (selector) => {
            const checkboxes = document.querySelectorAll(selector);
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    loadCrimeData(document.getElementById('dateInput').value, current);
                });
            });
        };

        addFilterListener('#weaponCategoryFilters input[type="checkbox"]');
        addFilterListener('#crimeCategoryFilters input[type="checkbox"]');
        addFilterListener('#victimSexFilters input[type="checkbox"]');
        addFilterListener('#victimDescentFilters input[type="checkbox"]');
        addFilterListener('#victimAgeFilters input[type="checkbox"]');

        // Toggle buttons
        const addToggleListener = (buttonId, filterId) => {
            document.getElementById(buttonId).addEventListener('click', function () {
                const filtersDiv = document.getElementById(filterId);
                if (filtersDiv.style.display === 'none') {
                    filtersDiv.style.display = 'block';
                    this.textContent = '-';
                } else {
                    filtersDiv.style.display = 'none';
                    this.textContent = '+';
                }
            });
        };

        addToggleListener('toggleWeaponCategories', 'weaponCategoryFilters');
        addToggleListener('toggleCrimeCategories', 'crimeCategoryFilters');
        addToggleListener('toggleVictimSex', 'victimSexFilters');
        addToggleListener('toggleVictimDescent', 'victimDescentFilters');
        addToggleListener('toggleVictimAge', 'victimAgeFilters');


        document.getElementById('regionsButton').addEventListener('click', function () {
            currentViewState = 'region';
            currentAprec = null;
            if (currentChoroplethLayer) {
                map.removeLayer(currentChoroplethLayer);
            }
            loadCrimeData(document.getElementById('dateInput').value, current);
            const grades = [0, 5, 10, "15+"];
            createLegend(grades, regionalColour);
        });

// Update the play button event listener to handle district view
document.getElementById('playButton').addEventListener('click', function() {
    if (!isPlaying) {
        isPlaying = true;
        interval = setInterval(() => {
            if (isWeeklyView) {
                if (currentWeekDay < 7) {
                    currentWeekDay++;
                    document.getElementById('weekScrubber').value = currentWeekDay;
                    document.getElementById('weekScrubberValue').innerText = getDayName(currentWeekDay);
                    
                    // Get the effective date for the current week day
                    const baseDate = document.getElementById('dateInput').value;
                    const effectiveDate = getDateFromWeekDay(baseDate, currentWeekDay);
                    
                    // Load data based on current view state
                    if (currentViewState === 'district') {
                        loadCrimeDataRegion(effectiveDate, current, currentAprec);
                    } else {
                        loadCrimeData(baseDate, current);
                    }
                } else {
                    clearInterval(interval);
                    isPlaying = false;
                }
            } else {
                if (current < 6) {
                    current++;
                    document.getElementById('scrubber').value = current;
                    document.getElementById('scrubberValue').innerText = getTimeRange(current);
                    
                    const date = document.getElementById('dateInput').value;
                    if (currentViewState === 'district') {
                        loadCrimeDataRegion(date, current, currentAprec);
                    } else {
                        loadCrimeData(date, current);
                    }
                } else {
                    clearInterval(interval);
                    isPlaying = false;
                }
            }
        }, 1400);
    }
});

// Update the weekly scrubber event listener to handle district view
document.getElementById('weekScrubber').addEventListener('input', function() {
    currentWeekDay = parseInt(this.value);
    document.getElementById('weekScrubberValue').innerText = getDayName(currentWeekDay);
    
    const baseDate = document.getElementById('dateInput').value;
    const effectiveDate = getDateFromWeekDay(baseDate, currentWeekDay);
    
    if (currentViewState === 'district') {
        loadCrimeDataRegion(effectiveDate, current, currentAprec);
    } else {
        loadCrimeData(baseDate, current);
    }
});

// Update the stop button to handle district view
document.getElementById('stopButton').addEventListener('click', function() {
    clearInterval(interval);
    isPlaying = false;
    
    const baseDate = document.getElementById('dateInput').value;
    
    if (isWeeklyView) {
        currentWeekDay = 1;
        document.getElementById('weekScrubber').value = currentWeekDay;
        document.getElementById('weekScrubberValue').innerText = getDayName(currentWeekDay);
        const effectiveDate = getDateFromWeekDay(baseDate, currentWeekDay);
        
        if (currentViewState === 'district') {
            loadCrimeDataRegion(effectiveDate, current, currentAprec);
        } else {
            loadCrimeData(baseDate, current);
        }
    } else {
        current = 1;
        document.getElementById('scrubber').value = current;
        document.getElementById('scrubberValue').innerText = getTimeRange(current);
        
        if (currentViewState === 'district') {
            loadCrimeDataRegion(baseDate, current, currentAprec);
        } else {
            loadCrimeData(baseDate, current);
        }
    }
});

// Also update the daily scrubber to handle district view
document.getElementById('scrubber').addEventListener('input', function() {
    current = parseInt(this.value);
    document.getElementById('scrubberValue').innerText = getTimeRange(current);
    
    const date = document.getElementById('dateInput').value;
    if (currentViewState === 'district') {
        loadCrimeDataRegion(date, current, currentAprec);
    } else {
        loadCrimeData(date, current);
    }
});

// Update the date input handler to handle district view
document.getElementById('dateInput').addEventListener('input', function() {
    const date = this.value;
    if (currentViewState === 'district') {
        if (isWeeklyView) {
            const effectiveDate = getDateFromWeekDay(date, currentWeekDay);
            loadCrimeDataRegion(effectiveDate, current, currentAprec);
        } else {
            loadCrimeDataRegion(date, current, currentAprec);
        }
    } else {
        loadCrimeData(date, current);
    }
});

 
        
        document.getElementById('pauseButton').addEventListener('click', function () {
            if (isPlaying) {
                clearInterval(interval);
                isPlaying = false;
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            const toggleButtons = document.querySelectorAll('.toggle-button');
            
            toggleButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetId = this.getAttribute('data-target');
                    const targetContent = document.getElementById(targetId);
                    const isExpanded = targetContent.classList.contains('expanded');
                    
                    // Toggle the expanded class
                    targetContent.classList.toggle('expanded');
                    
                    // Update the button text
                    this.textContent = isExpanded ? '+' : '-';
                });
            });
        });

        // Initial load
        const initialDate = "2024-01-01";
        loadCrimeData(initialDate, current);
        const grades = [0, 5, 10, "15+"];
        createLegend(grades, regionalColour);
        updateScrubberVisibility();
    </script>
</body>

</html>

